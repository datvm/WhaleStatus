<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EC2 Instance Controller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-center">EC2 Instance Controller</h3>
                    </div>
                    <div class="card-body">
                        <div id="loginForm">
                            <form id="authForm">
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Login & Get Status</button>
                            </form>
                        </div>
                        <div id="controlPanel" class="d-none">
                            <div class="alert" id="statusAlert"></div>
                            <div class="mb-3">
                                <button id="startBtn" class="btn btn-success w-100 mb-2">Turn On</button>
                                <button id="stopBtn" class="btn btn-danger w-100">Turn Off</button>
                            </div>
                            <div id="status"></div>
                            <button id="refreshBtn" class="btn btn-secondary w-100">Refresh Status</button>
                            <button id="logoutBtn" class="btn btn-outline-secondary w-100 mt-2">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://whale-controller-worker.lukevo.workers.dev'; // Replace with your Worker URL
        const INSTANCE_ID = 'i-1234567890abcdef0'; // Replace if not using env in backend
        let storedPassword = ''; // In-memory storage for the authenticated password

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            if (!password) return;

            try {
                const response = await fetch(`${WORKER_URL}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await response.json();
                if (data.success) {
                    storedPassword = password; // Retain for subsequent requests
                    document.getElementById('password').value = ''; // Clear input for privacy
                    document.getElementById('loginForm').classList.add('d-none');
                    document.getElementById('controlPanel').classList.remove('d-none');
                    updateStatus(data.status);
                } else {
                    alert('Invalid password');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        function updateStatus(status) {
            const statusDiv = document.getElementById('status');
            const alertDiv = document.getElementById('statusAlert');
            alertDiv.className = status.State.Name === 'running' ? 'alert alert-success' : 'alert alert-warning';
            alertDiv.textContent = `Status: ${status.State.Name} (${status.State.Code})`;
            statusDiv.innerHTML = `<pre>${JSON.stringify(status, null, 2)}</pre>`;
        }

        document.getElementById('startBtn').addEventListener('click', async () => {
            await performAction('start');
        });

        document.getElementById('stopBtn').addEventListener('click', async () => {
            await performAction('stop');
        });

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            if (!storedPassword) {
                alert('Please log in again.');
                return;
            }
            try {
                const response = await fetch(`${WORKER_URL}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: storedPassword })
                });
                const data = await response.json();
                if (data.success) {
                    updateStatus(data.status);
                } else {
                    alert('Session expired; please log in again.');
                    logout();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Optional: Add logout functionality to clear stored password
        document.getElementById('logoutBtn').addEventListener('click', () => {
            storedPassword = '';
            document.getElementById('controlPanel').classList.add('d-none');
            document.getElementById('loginForm').classList.remove('d-none');
            document.getElementById('statusAlert').className = '';
            document.getElementById('status').innerHTML = '';
        });

        async function performAction(action) {
            if (!storedPassword) {
                alert('Please log in again.');
                return;
            }
            try {
                const response = await fetch(`${WORKER_URL}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: storedPassword })
                });
                const data = await response.json();
                if (data.success) {
                    alert(`${action.charAt(0).toUpperCase() + action.slice(1)} initiated. Refresh status to confirm.`);
                } else {
                    alert('Action failed: ' + data.error + '. Please log in again.');
                    logout();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function logout() {
            storedPassword = '';
            document.getElementById('controlPanel').classList.add('d-none');
            document.getElementById('loginForm').classList.remove('d-none');
            document.getElementById('statusAlert').className = '';
            document.getElementById('status').innerHTML = '';
        }
    </script>
</body>
</html>